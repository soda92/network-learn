= 网络协议分析复习
:toc:

== ARP报文格式及封装

ARP报文由以下字段组成:

* 硬件类型
* 上层协议类型
* MAC地址长度
* IP地址长度
* 操作类型
* 源MAC地址
* 源IP地址
* 目的MAC地址
* 目的IP地址

ARP报文前封装以太网帧头:

* 目的MAC地址
* 源MAC地址
* 帧类型

== IP报文格式

. 版本号 
. 头长度
. 服务类型
. 总长度
. 标志
. 标识
. 片偏移
. 生存时间TTL
. 上层协议标识
. 头部校验和
. 源IP地址
. 目的IP地址
. 选项
. 填充
. 数据

== ICMP报文类型
类型下的子类型由代码字段规定。

. 3: 表示主机/协议或端口不可达
. 4: 源点抑制(路由器表示发送拥塞)
. 5: 改变路由(路由器表示有更好的路由)
. 11: 表示TTL为0或分片重组超时
. 12: 表示参数错误(如需要分片但设置了DF)
. 8/0: 表示回显请求/回显应答
. 13/14: 表示时间戳请求/时间戳应答

== IP首部选项

. 安全和处理限制(用于军事领域)
. 记录路径(让每个路由器都记下它的ip地址)
. 时间戳(让每个路由器都记下它的IP地址和时间)
. 宽松的源站路由
. 严格的源站路由

== UDP报文格式

源端口、目的端口、长度、校验和、数据

== UDP-Lite

*报文长度* 被替换为 *校验和覆盖* 字段

== PAP认证协议

被认证方向认证方发送账号和密码来认证身份。

== CHAP认证协议

认证方向被认证方发送一个随机数，被认证方使用密码计算散列值，发给验证方来验证身份。

== 分片的识别

MF=0并且片偏移量为0，说明不是分片；否则是分片。

== ICMP

用于控制和报告错误。


== TCP连接的建立

. 客户端发送SYN报文给服务器，序号为i
. 服务器收到后，发送SYN报文给客户端，序号为j，确认号为i+1
. 客户端收到后，发送ACK报文，序号为i+1，确认号为j+1
. 服务端收到后，连接建立

== TCP连接的关闭

. 客户端发送FIN报文给服务器，序号为m
. 服务器收到后，发送ACK报文给客户端，序号为n，确认号为m+1
. 此时服务器处于半关闭状态，可以继续发送数据
. 服务器发送FIN报文，序号为w，确认号为m+1
. 客户端收到后回复ACK报文，序号为m+1，确认号为w+1
. 客户端等待2MSL后关闭，服务器收到lastack后关闭。

异常关闭

一方发送RST，此时双方立即关闭连接

== PPP协议的流程

. 双方发送LCP数据报来配置和测试数据链路。当连接建立后，双方可以要求使用PAP或CHAP认证身份。

. 双方通过NCP包来选择和配置一个或多个网络层协议。当所有的网络层协议都被配置后，这些协议的数据报可以被发送。

. 链路会一直保持开启，直到一方使用LCP或NCP包关闭连接，或一些外部事件发生（活跃计时器过期或网络管理员的干预）。

== TCP确认机制的特点

. TCP的确认序号指明的是期望收到的下一个报文段的序号
. 累计确认。TCP的确认信息会报告已经积累了多少个字节的数据流
. 捎带确认。一方通常不单独发送确认，而是把确认信息放到发给对方的数据中。

== 慢启动和拥塞避免

. 在一个TCP连接建立时，发送端将拥塞窗口初始化为该连接上当前使用的最大数据大小(CWND=MSS)。
. 每当收到一个对数据报的确认，CWND增大为原来的2倍。
. 当有数据报丢失时，设置慢启动阈值为当前拥塞窗口的一半(SSTHRESH=CWND/2)，然后调用拥塞避免算法
. 每收到一个对数据报的确认，CWND增加为原来的2倍，但当CWND值达到SSTHRESH时，每收到一个确认，CWND增加一个MSS
. 再次发生数据丢失时重复3以后的步骤

== 快重传和快恢复

. 当接收端收到一个不是按序到达的数据段时，发送一个重复ACK数据段。确认号为期望收到的数据序号
. 发送端收到三个重复的ACK后，立即重传丢失的数据段，同时将CWND设置为SSTHRESH的一半，然后执行拥塞避免算法，使CWND缓慢增长。


== FreeBSD分片重组算法

两个数据结构: 等待重组的数据报ipq；分片ipasfrag。

过程:

. 检测是否是分片
. 将分片插入对应的ipq中，没有则新建ipq。
. 到达总长度时进行合并，交付上层应用
. 超时返回失败状态
. 释放分片占用的资源

== 点到点和端到端通信

点到点指对等实体间的通信由一段段直接相连的机器间的通信组成，“端到端”则指对等实体间的通信像拥有一条直接线路。

[NOTE]
点到点针对终端节点，端到端针对应用进程。


== TCP/IP分层模型中的两个边界

. 操作系统边界
. 协议地址边界

== IP分片重组的承担者

目的主机

. 简化路由器操作
. 避免重复分片
. 每个分片可以独自选路，增强了通信的灵活性

== 跨网转发数据报时ARP的使用和数据帧传输步骤

使用ARP获取目的MAC；设置数据帧源MAC和目的MAC；发送

== TCP时间戳选项中tsrecent的取值

. 当包含lastack的报文到达时，其中的时间戳被保存至tsrecent。
. 无论何时发送确认，tsrecent都被写入时间戳回显应答字段，确认序号则被保存至lastack。

== TCP/IP的网络字节顺序

在低地址区域存放数据的低字节成为小端点机，存放高字节称为大端点机。TCP/IP规定首先发送数据的高字节。

== ARP实现基本的地址冲突检测

主机接收到DHCP服务器分配的IP地址后，向该IP发送一个ARP请求，收到响应则说明IP地址被占用。

== LCP（链路控制协议）配置字段类型及作用

MRU:: 通告最大接受单元
认证协议:: 用于认证，有PAP和CHAP两种，可选
质量协议:: 用于检测数据丢失
幻数:: 用于防止环路
PFC:: 用于协商协议字段压缩
ACFC:: 用于协商地址和控制字段的压缩

== SWS的起因和避免策略

起因::
接收方的小窗口通告造成发送方发送一系列小的报文段。

接收方的避免策略::
接收方在缓冲区满后，等到缓冲区可用空间达到总空间的一半后才发送新的窗口通告，此外，在窗口大小不足以达到特定的限度时推迟发送确认。

发送方的避免策略::
避免发送小报文段。等到数据长度达到MSS后才发送。