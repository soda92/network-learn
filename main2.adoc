= 网络协议分析复习: IP ICMP UDP
:toc:
== IP报文格式

. 版本号 
. 头长度
. 服务类型
. 总长度
. 标志
. 标识
. 片偏移
. 生存时间TTL
. 上层协议标识
. 头部校验和
. 源IP地址
. 目的IP地址
. 选项
. 填充
. 数据

== IP分片重组的承担者

目的主机

. 简化路由器操作
. 避免重复分片
. 每个分片可以独自选路, 增强了通信的灵活性

== 分片的识别

MF=0并且片偏移量为0, 说明不是分片; 否则是分片.

== FreeBSD分片重组算法

两个数据结构: 等待重组的数据报ipq; 分片ipasfrag.

过程:

. 检测是否是分片
. 将分片插入对应的ipq中, 没有则新建ipq.
. 到达总长度时进行合并, 交付上层应用
. 超时返回失败状态
. 释放分片占用的资源

== IP首部选项

. 安全和处理限制(用于军事领域)
. 记录路径(让每个路由器都记下它的ip地址)
. 时间戳(让每个路由器都记下它的IP地址和时间)
. 宽松的源站路由
. 严格的源站路由

== ICMP

用于控制和报告错误.

== ICMP报文类型
类型下的子类型由代码字段规定.

. 3: 表示主机/协议或端口不可达
. 4: 源点抑制(路由器表示发送拥塞)
. 5: 改变路由(路由器表示有更好的路由)
. 11: 表示TTL为0或分片重组超时
. 12: 表示参数错误(如需要分片但设置了DF)
. 8/0: 表示回显请求/回显应答
. 13/14: 表示时间戳请求/时间戳应答

== UDP报文格式

源端口、目的端口、长度、校验和、数据

== UDP-Lite

*报文长度* 被替换为 *校验和覆盖* 字段